#!/usr/bin/env ruby
# encoding: UTF-8

BEGIN {
    unless ENV["INIQUITY_HOME"]
        abort "Please set the INIQUITY_HOME environment variable."
    end
}

require "iniquity"
require "inifile"
require "thin"

trap("INT") {exit}

EM.run do

    config = IniFile.load(ENV["INIQUITY_HOME"] + "/iniquity.ini")

    config.each_section do |section|

        if section == "terminal"
            if config["terminal"]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Terminal
            end
        end

        if section == "web"
            if config["web"]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Web
            end
        end

        if section == "rest"
            if config["rest"]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Rest
            end
        end

        ### WFC Screen

        puts "Iniquity: WFC Coming Soon!"

        EM.add_periodic_timer(15) do
            puts "Iniquity: WFC Coming Soon!"
        end
    end
end

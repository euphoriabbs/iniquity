#!/usr/bin/env ruby
# encoding: UTF-8

BEGIN {
    unless ARGV[0] || ENV["INIQUITY_HOME"]
        abort "Please set the INIQUITY_HOME environment variable."
    end
}

HOME = ARGV[0] || ENV["INIQUITY_HOME"] || "."
ENV["INIQUITY_HOME"] = HOME

require "iniquity"
require "inifile"
require "thin"

trap("INT") {exit}

EM.run do

    config = IniFile.load(HOME+ "/iniquity.ini")

    ### Events

    EM.add_periodic_timer(15) do
        puts "Event: Nothing to see here..."
    end

    ### Services

    config.each_section do |section|

        if section == "telnet"
            if config[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Telnet
            end
        end

        if section == "http"
            if config[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Http
            end
        end

        if section == "rest"
            if config[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Rest
            end
        end
    end
end

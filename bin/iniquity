#!/usr/bin/env ruby
# encoding: UTF-8

BEGIN {
    unless ARGV[0] || ENV["INIQUITY_SYSTEM"]
        abort "Please set the INIQUITY_SYSTEM environment variable."
    end
}

HOME = ARGV[0] || ENV["INIQUITY_SYSTEM"]
ENV["INIQUITY_SYSTEM"] = HOME

require "inifile"
require "thin"
require "socksify"

if File.exists?(HOME+ "/iniquity.ini")
    CONFIG = IniFile.load(HOME+ "/iniquity.ini")
else
    abort "An Iniquity system must have an iniquity.ini file."

if CONFIG["tor"]["enabled"] == "yes"
    TCPSocket::socks_server = CONFIG["tor"]["address"]
    TCPSocket::socks_port = CONFIG["tor"]["port"]
end

class Telnet < EM::Connection

    def initialize
        super
        send_data "\nIniquity BBS 0.0.3 - Telnet/UTF_8\n"
    end

    def post_init

        puts "-- Someone connected to the Iniquity Telnet service."

        #IO.readlines("./modules/welcome.ans").each do |line|
        #    send_data line.force_encoding(Encoding::IBM437).encode(Encoding::UTF_8)
        #end

        #def wrap(s, width=78)
        #    s.gsub(/(.{1,#{width}})(\s+|\Z)/, "\\1\n")
        #end

        #send_data wrap("Eu duis consequat laborum sunt incididunt deserunt dolor nisi eu occaecat commodo ad. Reprehenderit aute laboris Lorem ex cillum ipsum laborum irure excepteur sint do pariatur Lorem sit. Aliqua ipsum dolor quis ea. Tempor non ipsum consequat proident fugiat ad id laboris aliquip amet magna.\n", 78)
    end

    def receive_data data
        #send_data ">>>you sent: #{data}"
        close_connection if data =~ /quit|q|goodbye|g|logoff|l/i
    end

    def unbind
        puts "-- Someone disconnected from the Iniquity Telnet service."
    end
end

class Http < EM::Connection
    def initialize
        super
    end
    def post_init
    end
    def receive_data
    end
    def unbind
    end
end

class Rest < EM::Connection
    def initialize
        super
    end
    def post_init
    end
    def receive_data
    end
    def unbind
    end
end

EM.run do

    ### Events

    EM.add_periodic_timer(15) do
        puts "Event: Nothing to see here..."
    end

    ### Services

    CONFIG.each_section do |section|

        if section == "telnet"
            if CONFIG[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", CONFIG[section]["port"], Telnet
            end
        end

        if section == "http"
            if CONFIG[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", CONFIG[section]["port"], Http
            end
        end

        if section == "rest"
            if CONFIG[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", CONFIG[section]["port"], Rest
            end
        end
    end
end

trap("INT") {exit}

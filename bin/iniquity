#!/usr/bin/env ruby
# encoding: UTF-8

BEGIN {
    unless ARGV[0] || ENV["INIQUITY_HOME"]
        abort "Please set the INIQUITY_HOME environment variable."
    end
}

HOME = ARGV[0] || ENV["INIQUITY_HOME"] || "."
ENV["INIQUITY_HOME"] = HOME

require "iniquity"
require "inifile"
require "thin"

trap("INT") {exit}

EM.run do

    ### WFC Screen

    EM.add_periodic_timer(15) do
        puts "Iniquity: WFC Coming Soon!"
    end

    config = IniFile.load(HOME+ "/iniquity.ini")

    config.each_section do |section|

        if section == "terminal"
            if config[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Terminal
            end
        end

        if section == "web"
            if config[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], Web
            end
        end

        if section == "api"
            if config[section]["enabled"] == "yes"
                EM.start_server "0.0.0.0", config[section]["port"], API
            end
        end
    end
end
